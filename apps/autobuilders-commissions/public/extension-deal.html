<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Autobuilders Commissions</title>
    <style>
      :root {
        color-scheme: light dark;
      }

      body {
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: #0b1120;
        color: #e2e8f0;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
      }

      main {
        text-align: center;
        padding: 24px;
        border-radius: 12px;
        background: rgba(15, 23, 42, 0.88);
        box-shadow: 0 20px 40px rgba(15, 23, 42, 0.3);
        width: min(360px, 90vw);
      }

      h1 {
        margin: 0 0 12px;
        font-size: 20px;
      }

      p {
        margin: 6px 0;
      }

      .deal-id {
        margin-top: 16px;
        font-size: 18px;
        font-weight: 600;
      }

      .source-hint {
        margin-top: 6px;
        font-size: 13px;
        color: rgba(226, 232, 240, 0.7);
      }

      .error {
        color: #f87171;
      }

      .tips {
        font-size: 13px;
        margin-top: 12px;
        color: rgba(226, 232, 240, 0.75);
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@pipedrive/app-extensions-sdk@0/dist/index.umd.js"></script>
  </head>
  <body>
    <main id="root">
      <h1>Loading commissions panelâ€¦</h1>
      <p>Connecting to Pipedrive SDK.</p>
    </main>
    <script>
      (function () {
        const root = document.getElementById("root");

        function getDealIdFromQuery() {
          const params = new URLSearchParams(window.location.search);
          return (
            params.get("dealId") ||
            params.get("deal_id") ||
            params.get("itemId") ||
            params.get("id") ||
            null
          );
        }

        function coerceId(value) {
          if (value === null || value === undefined) {
            return null;
          }
          const trimmed = String(value).trim();
          return trimmed.length ? trimmed : null;
        }

        function extractDealId(context) {
          if (!context || typeof context !== "object") {
            return null;
          }

          const candidates = [
            context.dealId,
            context.deal_id,
            context.deal && context.deal.id,
            context.itemId,
            context.item && context.item.id,
            context.entity && context.entity.id,
            context.object && context.object.id,
            Array.isArray(context.selectedIds) ? context.selectedIds[0] : null,
            context.id,
          ];

          for (const candidate of candidates) {
            const coerced = coerceId(candidate);
            if (coerced) {
              return coerced;
            }
          }

          return null;
        }

        function showResult(result) {
          root.innerHTML = `
            <h1>Commissions panel ready.</h1>
            <p class="deal-id">Deal ID: ${result.dealId}</p>
            <p class="source-hint">Detected via ${result.source}.</p>
          `;
        }

        function showError(message) {
          root.innerHTML = `
            <h1 class="error">Unable to detect deal ID</h1>
            <p>${message}</p>
            <p class="tips">Confirm this iframe is rendered inside a Deal panel.</p>
          `;
        }

        async function initialize() {
          const fallbackId = coerceId(getDealIdFromQuery());

          if (!window.AppExtensionsSDK) {
            if (fallbackId) {
              showResult({ dealId: fallbackId, source: "query string" });
              return;
            }
            showError("Pipedrive SDK is not available.");
            return;
          }

          const sdk = new window.AppExtensionsSDK();
          let context = null;

          try {
            const initResult = await sdk.initialize();
            if (initResult && typeof initResult === "object") {
              context = initResult.context || initResult.data || initResult;
            }
          } catch (error) {
            console.warn("Pipedrive SDK initialize failed", error);
          }

          if (!context && typeof sdk.getContext === "function") {
            try {
              context = await sdk.getContext();
            } catch (error) {
              console.warn("sdk.getContext() failed", error);
            }
          }

          if (!context && sdk.context && typeof sdk.context === "object") {
            context = sdk.context;
          }

          const dealIdFromContext = coerceId(extractDealId(context));
          const dealId = dealIdFromContext || fallbackId;

          if (dealId) {
            showResult({
              dealId,
              source: dealIdFromContext ? "Pipedrive context" : "query string",
            });
            return;
          }

          showError("No deal ID found in SDK context or query parameters.");
        }

        initialize();
      })();
    </script>
  </body>
</html>
