<!DOCTYPE html><html>

<html>  <head>

<head>    <meta charset="UTF-8" />

  <meta charset="UTF-8" />    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />    <title>Commission Calculator</title>

  <title>Commission Calculator</title>    <style>

  <style>      * { box-sizing: border-box; margin: 0; padding: 0; } body { font-family:

    * {      -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu,

      box-sizing: border-box;      Cantarell, sans-serif; font-size: 14px; line-height: 1.5; color: #333;

      margin: 0;      padding: 16px; background: #f9fafb; } .container { max-width: 800px;

      padding: 0;      margin: 0 auto; } h2 { font-size: 18px; font-weight: 600; margin-bottom:

    }      16px; color: #1a1a1a; } h3 { font-size: 16px; font-weight: 600;

      margin-top: 24px; margin-bottom: 12px; color: #1a1a1a; } .summary-card {

    body {      function extractContextFromUrl() { const params = new

      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;      URLSearchParams(window.location.search); return { dealId:

      font-size: 14px;      params.get('dealId') || params.get('deal_id'), userId:

      line-height: 1.5;      params.get('userId') || params.get('user_id'), companyId:

      color: #333;      params.get('companyId') || params.get('company_id'), personId:

      padding: 16px;      params.get('personId') || params.get('person_id'), organizationId:

      background: #f9fafb;      params.get('orgId') || params.get('organization_id') ||

    }      params.get('org_id'), }; } async function init() { try {

      showDebug('Starting initialization...'); if (typeof

    .container {      window.AppExtensionsSDK !== 'function') { showError('Pipedrive SDK global

      max-width: 800px;      not available'); return; } showDebug('Instantiating SDK...'); sdk = new

      margin: 0 auto;      window.AppExtensionsSDK(); await sdk.initialize(); showDebug('SDK

    }      initialized successfully'); let context; if (typeof sdk.getContext ===

      'function') { try { context = await sdk.getContext(); showDebug('Context

    h2 {      retrieved via sdk.getContext'); } catch (contextError) {

      font-size: 18px;      showDebug('sdk.getContext failed: ' + contextError.message); } } if

      font-weight: 600;      (!context && sdk.context) { context = sdk.context; showDebug('Context read

      margin-bottom: 16px;      from sdk.context'); } if (!context) { context = extractContextFromUrl();

      color: #1a1a1a;      showDebug('Context derived from URL params'); } showDebug('Context: ' +

    }      JSON.stringify(context)); dealId = context?.dealId || context?.deal_id ||

      null; selectedUserId = context?.userId || context?.user_id || null;

    h3 {      showDebug('Deal ID: ' + dealId + ', User ID: ' + selectedUserId); if

      font-size: 16px;      (!dealId) { showError('No deal ID available from SDK or URL'); return; }

      font-weight: 600;      await loadCommissionData(); } catch (error) {

      margin-top: 24px;      console.error('Initialization error:', error); showDebug('Error: ' +

      margin-bottom: 12px;      error.message); showDebug('Stack: ' + error.stack); showError('Failed to

      color: #1a1a1a;      initialize: ' + error.message); } } tr:last-child td { border-bottom:

    }      none; } tr:hover { background: #f9fafb; } .badge { display: inline-block;

      padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 500;

    .summary-card {      text-transform: uppercase; } .badge-deposit { background: #dbeafe; color:

      background: #fff;      #1e40af; } .badge-total { background: #d1fae5; color: #065f46; } .currency

      border: 1px solid #e5e7eb;      { font-family: 'Courier New', monospace; font-weight: 500; } .btn {

      border-radius: 8px;      display: inline-block; padding: 8px 16px; background: #2563eb; color:

      padding: 16px;      white; border: none; border-radius: 6px; font-size: 14px; font-weight:

      margin-bottom: 16px;      500; cursor: pointer; transition: background 0.2s; } .btn:hover {

    }      background: #1d4ed8; } .btn:disabled { background: #9ca3af; cursor:

      not-allowed; } .btn-secondary { background: white; color: #374151; border:

    .summary-grid {      1px solid #d1d5db; } .btn-secondary:hover { background: #f9fafb; }

      display: grid;      .input-group { display: flex; gap: 8px; margin-bottom: 16px; }

      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));      input[type="text"], input[type="number"], select { padding: 8px 12px;

      gap: 16px;      border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; flex: 1; }

    }      input[type="text"]:focus, input[type="number"]:focus, select:focus {

      outline: none; border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37, 99,

    .summary-item {      235, 0.1); } .row { display: flex; gap: 8px; align-items: center;

      display: flex;      margin-bottom: 8px; padding: 8px; background: #f9fafb; border-radius: 6px;

      flex-direction: column;      } .row input, .row select { margin: 0; } .btn-remove { padding: 6px 12px;

    }      background: #ef4444; color: white; border: none; border-radius: 4px;

      cursor: pointer; font-size: 12px; } .btn-remove:hover { background:

    .summary-label {      #dc2626; } .error { background: #fee2e2; border: 1px solid #fecaca; color:

      font-size: 12px;      #991b1b; padding: 12px; border-radius: 6px; margin-bottom: 16px; }

      color: #6b7280;      .loading { text-align: center; padding: 40px; color: #6b7280; }

      margin-bottom: 4px;      .config-editor { background: white; border: 1px solid #e5e7eb;

      text-transform: uppercase;      border-radius: 8px; padding: 16px; margin-bottom: 16px; } .total-row {

      letter-spacing: 0.5px;      background: #f0fdf4 !important; font-weight: 600; } .text-right {

    }      text-align: right; } .small { font-size: 12px; color: #6b7280; }

      .debug-info { background: #f3f4f6; border: 1px solid #d1d5db;

    .summary-value {      border-radius: 6px; padding: 12px; margin-bottom: 16px; font-family:

      font-size: 20px;      monospace; font-size: 12px; }

      font-weight: 600;    </style>

      color: #1a1a1a;  </head>

    }  <body>

    <div class="container">

    .table-container {      <h2>ðŸ’° Commission Calculator</h2>

      background: #fff;

      border: 1px solid #e5e7eb;      <div id="loading" class="loading">

      border-radius: 8px;        Loading deal information...

      overflow: hidden;      </div>

      margin-bottom: 16px;

    }      <div id="error" class="error" style="display: none;"></div>



    table {      <div id="debug" class="debug-info" style="display: none;"></div>

      width: 100%;

      border-collapse: collapse;      <div id="content" style="display: none;">

    }        <div class="summary-card">

          <div class="summary-grid">

    th {            <div class="summary-item">

      background: #f9fafb;              <span class="summary-label">Deal Value</span>

      padding: 12px;              <span class="summary-value currency" id="dealValue">â‚¬0</span>

      text-align: left;            </div>

      font-weight: 600;            <div class="summary-item">

      font-size: 12px;              <span class="summary-label">Deposit (<span

      color: #6b7280;                  id="depositPercent"

      text-transform: uppercase;                >0</span>%)</span>

      letter-spacing: 0.5px;              <span class="summary-value currency" id="depositAmount">â‚¬0</span>

      border-bottom: 1px solid #e5e7eb;            </div>

    }            <div class="summary-item">

              <span class="summary-label">Remaining</span>

    td {              <span

      padding: 12px;                class="summary-value currency"

      border-bottom: 1px solid #f3f4f6;                id="remainingAmount"

    }              >â‚¬0</span>

            </div>

    tr:last-child td {          </div>

      border-bottom: none;        </div>

    }

        <div class="config-editor">

    tr:hover {          <h3>Commission Configuration</h3>

      background: #f9fafb;          <div id="commissionRows"></div>

    }          <button class="btn btn-secondary" onclick="addRow()">+ Add Party</button>

          <button

    .badge {            class="btn"

      display: inline-block;            onclick="saveAndCalculate()"

      padding: 2px 8px;            style="margin-left: 8px;"

      border-radius: 12px;          >Calculate</button>

      font-size: 11px;        </div>

      font-weight: 500;

      text-transform: uppercase;        <div class="table-container">

    }          <h3 style="padding: 16px; padding-bottom: 0;">Commission Breakdown</h3>

          <table id="resultsTable">

    .badge-deposit {            <thead>

      background: #dbeafe;              <tr>

      color: #1e40af;                <th>Party</th>

    }                <th>Applies To</th>

                <th class="text-right">Base Amount</th>

    .badge-total {                <th class="text-right">Rate</th>

      background: #d1fae5;                <th class="text-right">% Amount</th>

      color: #065f46;                <th class="text-right">Fixed</th>

    }                <th class="text-right">Total</th>

              </tr>

    .currency {            </thead>

      font-family: 'Courier New', monospace;            <tbody id="resultsBody">

      font-weight: 500;            </tbody>

    }          </table>

        </div>

    .btn {      </div>

      display: inline-block;    </div>

      padding: 8px 16px;

      background: #2563eb;    <script

      color: #fff;      src="https://cdn.jsdelivr.net/npm/@pipedrive/app-extensions-sdk@0/dist/index.umd.js"

      border: none;    ></script>

      border-radius: 6px;    <script>

      font-size: 14px;      let sdk; let dealId; let selectedUserId; let commissionConfig = [];

      font-weight: 500;      function showDebug(message) { const debugEl =

      cursor: pointer;      document.getElementById('debug'); if (debugEl) { debugEl.style.display =

      transition: background 0.2s ease;      'block'; debugEl.innerHTML += message + '<br>'; } console.log('[DEBUG]',

    }      message); } async function init() { try { showDebug('Starting

      initialization...'); // Wait for SDK to load if (typeof

    .btn:hover {      window.AppExtensionsSDK === 'undefined') { showDebug('Waiting for SDK to

      background: #1d4ed8;      load...'); await new Promise((resolve, reject) => { const checkSDK =

    }      setInterval(() => { if (typeof window.AppExtensionsSDK !== 'undefined') {

      clearInterval(checkSDK); resolve(); } }, 100); // Timeout after 5 seconds

    .btn:disabled {      setTimeout(() => { clearInterval(checkSDK); reject(new Error('Timeout

      background: #9ca3af;      waiting for Pipedrive SDK to load')); }, 5000); }); } showDebug('SDK

      cursor: not-allowed;      found, initializing...'); sdk = await

    }      window.AppExtensionsSDK.initialize(); showDebug('SDK initialized

      successfully'); const context = await sdk.getContext();

    .btn-secondary {      showDebug('Context: ' + JSON.stringify(context)); dealId = context.dealId;

      background: #fff;      selectedUserId = context.userId; showDebug('Deal ID: ' + dealId + ', User

      color: #374151;      ID: ' + selectedUserId); if (!dealId) { showError('No deal ID found in

      border: 1px solid #d1d5db;      context'); return; } await loadCommissionData(); } catch (error) {

    }      console.error('Initialization error:', error); showDebug('Error: ' +

      error.message); showDebug('Stack: ' + error.stack); showError('Failed to

    .btn-secondary:hover {      initialize: ' + error.message); } } async function loadCommissionData() {

      background: #f9fafb;      try { showDebug('Fetching commission data...'); const response = await

    }      fetch('/api/calculate-commission', { method: 'POST', headers: {

      'Content-Type': 'application/json' }, body: JSON.stringify({ dealId:

    .input-group {      dealId, selectedUserId: selectedUserId }) }); showDebug('Response status:

      display: flex;      ' + response.status); if (!response.ok) { const errorText = await

      gap: 8px;      response.text(); showDebug('Error response: ' + errorText); throw new

      margin-bottom: 16px;      Error('Failed to load commission data: ' + response.status); } const data

    }      = await response.json(); showDebug('Data received: ' +

      JSON.stringify(data)); commissionConfig = data.commissionConfig || [];

    input[type="text"],      displaySummary(data); renderCommissionRows();

    input[type="number"],      displayResults(data.calculations || []);

    select {      document.getElementById('loading').style.display = 'none';

      padding: 8px 12px;      document.getElementById('content').style.display = 'block'; } catch

      border: 1px solid #d1d5db;      (error) { console.error('Error loading data:', error); showDebug('Load

      border-radius: 6px;      error: ' + error.message); showError('Failed to load commission data: ' +

      font-size: 14px;      error.message); } } function displaySummary(data) {

      flex: 1;      document.getElementById('dealValue').textContent =

    }      formatCurrency(data.dealValue);

      document.getElementById('depositPercent').textContent =

    input[type="text"]:focus,      data.depositPercent.toFixed(0);

    input[type="number"]:focus,      document.getElementById('depositAmount').textContent =

    select:focus {      formatCurrency(data.depositAmount);

      outline: none;      document.getElementById('remainingAmount').textContent =

      border-color: #2563eb;      formatCurrency(data.remainingAmount); } function renderCommissionRows() {

      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);      const container = document.getElementById('commissionRows');

    }      container.innerHTML = ''; if (commissionConfig.length === 0) {

      commissionConfig = [ { name: 'Mathieu', percent: 65, fixed: 0, appliesTo:

    .row {      'total' }, { name: 'Sacha', percent: 35, fixed: 0, appliesTo: 'total' } ];

      display: flex;      } commissionConfig.forEach((config, index) => { const row =

      gap: 8px;      document.createElement('div'); row.className = 'row'; row.innerHTML = `

      align-items: center;      <input type="text" placeholder="Name" value="${config.name}"

      margin-bottom: 8px;      onchange="updateConfig(${index}, 'name', this.value)" style="flex: 2;">

      padding: 8px;      <input type="number" placeholder="%" value="${config.percent}"

      background: #f9fafb;      onchange="updateConfig(${index}, 'percent', parseFloat(this.value))"

      border-radius: 6px;      style="flex: 1;"> <span class="small">%</span> <input type="number"

    }      placeholder="Fixed" value="${config.fixed}"

      onchange="updateConfig(${index}, 'fixed', parseFloat(this.value))"

    .row input,      style="flex: 1;"> <span class="small">â‚¬</span> <select

    .row select {      onchange="updateConfig(${index}, 'appliesTo', this.value)" style="flex:

      margin: 0;      1;"> <option value="total" ${config.appliesTo === 'total' ? 'selected' :

    }      ''}>Total</option> <option value="deposit" ${config.appliesTo ===

      'deposit' ? 'selected' : ''}>Deposit</option> </select> <button

    .btn-remove {      class="btn-remove" onclick="removeRow(${index})">âœ•</button> `;

      padding: 6px 12px;      container.appendChild(row); }); } function updateConfig(index, field,

      background: #ef4444;      value) { commissionConfig[index][field] = value; } function addRow() {

      color: #fff;      commissionConfig.push({ name: '', percent: 0, fixed: 0, appliesTo: 'total'

      border: none;      }); renderCommissionRows(); } function removeRow(index) {

      border-radius: 4px;      commissionConfig.splice(index, 1); renderCommissionRows(); } async

      cursor: pointer;      function saveAndCalculate() { try { showDebug('Saving configuration...');

      font-size: 12px;      if (sdk && typeof sdk.execute === 'function' &&

    }      window.AppExtensionsSDK?.Command?.UPDATE) { await

      sdk.execute(window.AppExtensionsSDK.Command.UPDATE, {

    .btn-remove:hover {      commission_config_json: JSON.stringify(commissionConfig) });

      background: #dc2626;      showDebug('Configuration saved via SDK command, reloading...'); } else {

    }      showDebug('SDK update command unavailable. Skipping direct save; consider

      implementing server-side persistence.'); } // Reload the calculations

    .error {      regardless so UI reflects latest state await loadCommissionData(); } catch

      background: #fee2e2;      (error) { console.error('Error saving:', error); showDebug('Save error: '

      border: 1px solid #fecaca;      + error.message); showError('Failed to save configuration: ' +

      color: #991b1b;      error.message); } } function displayResults(calculations) { const tbody =

      padding: 12px;      document.getElementById('resultsBody'); tbody.innerHTML = ''; let totalSum

      border-radius: 6px;      = 0; calculations.forEach(calc => { const row =

      margin-bottom: 16px;      document.createElement('tr'); row.innerHTML = `

    }      <td><strong>${calc.name}</strong></td> <td><span class="badge

      badge-${calc.appliesTo}">${calc.appliesTo}</span></td> <td

    .loading {      class="text-right currency">${formatCurrency(calc.baseAmount)}</td> <td

      text-align: center;      class="text-right">${calc.percent}%</td> <td class="text-right

      padding: 40px;      currency">${formatCurrency(calc.percentAmount)}</td> <td class="text-right

      color: #6b7280;      currency">${formatCurrency(calc.fixed)}</td> <td class="text-right

    }      currency"><strong>${formatCurrency(calc.total)}</strong></td> `;

      tbody.appendChild(row); totalSum += calc.total; }); // Add total row const

    .config-editor {      totalRow = document.createElement('tr'); totalRow.className = 'total-row';

      background: #fff;      totalRow.innerHTML = ` <td colspan="6"

      border: 1px solid #e5e7eb;      class="text-right"><strong>TOTAL</strong></td> <td class="text-right

      border-radius: 8px;      currency"><strong>${formatCurrency(totalSum)}</strong></td> `;

      padding: 16px;      tbody.appendChild(totalRow); } function formatCurrency(amount) { return

      margin-bottom: 16px;      new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR'

    }      }).format(amount); } function showError(message) {

      document.getElementById('loading').style.display = 'none';

    .total-row {      document.getElementById('error').textContent = message;

      background: #f0fdf4 !important;      document.getElementById('error').style.display = 'block'; } // Initialize

      font-weight: 600;      when page loads if (document.readyState === 'loading') {

    }      document.addEventListener('DOMContentLoaded', init); } else { init(); }

    </script>

    .text-right {  </body>

      text-align: right;</html>
    }

    .small {
      font-size: 12px;
      color: #6b7280;
    }

    .debug-info {
      background: #f3f4f6;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 16px;
      font-family: monospace;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>ðŸ’° Commission Calculator</h2>

    <div id="loading" class="loading">
      Loading deal information...
    </div>

    <div id="error" class="error" style="display: none;"></div>

    <div id="debug" class="debug-info" style="display: none;"></div>

    <div id="content" style="display: none;">
      <div class="summary-card">
        <div class="summary-grid">
          <div class="summary-item">
            <span class="summary-label">Deal Value</span>
            <span class="summary-value currency" id="dealValue">â‚¬0</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Deposit (<span id="depositPercent">0</span>%)</span>
            <span class="summary-value currency" id="depositAmount">â‚¬0</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Remaining</span>
            <span class="summary-value currency" id="remainingAmount">â‚¬0</span>
          </div>
        </div>
      </div>

      <div class="config-editor">
        <h3>Commission Configuration</h3>
        <div id="commissionRows"></div>
        <button class="btn btn-secondary" onclick="addRow()">+ Add Party</button>
        <button class="btn" onclick="saveAndCalculate()" style="margin-left: 8px;">Calculate</button>
      </div>

      <div class="table-container">
        <h3 style="padding: 16px; padding-bottom: 0;">Commission Breakdown</h3>
        <table id="resultsTable">
          <thead>
            <tr>
              <th>Party</th>
              <th>Applies To</th>
              <th class="text-right">Base Amount</th>
              <th class="text-right">Rate</th>
              <th class="text-right">% Amount</th>
              <th class="text-right">Fixed</th>
              <th class="text-right">Total</th>
            </tr>
          </thead>
          <tbody id="resultsBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@pipedrive/app-extensions-sdk@0/dist/index.umd.js"></script>
  <script>
    let sdk;
    let dealId;
    let selectedUserId;
    let commissionConfig = [];

    function showDebug(message) {
      const debugEl = document.getElementById('debug');
      if (debugEl) {
        debugEl.style.display = 'block';
        debugEl.innerHTML += message + '<br>';
      }
      console.log('[DEBUG]', message);
    }

    function showError(message) {
      document.getElementById('loading').style.display = 'none';
      const errorEl = document.getElementById('error');
      errorEl.textContent = message;
      errorEl.style.display = 'block';
    }

    function formatCurrency(amount) {
      return new Intl.NumberFormat('fr-FR', {
        style: 'currency',
        currency: 'EUR'
      }).format(amount);
    }

    function extractContextFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return {
        dealId: params.get('dealId') || params.get('deal_id'),
        userId: params.get('userId') || params.get('user_id'),
        companyId: params.get('companyId') || params.get('company_id'),
        personId: params.get('personId') || params.get('person_id'),
        organizationId: params.get('orgId') || params.get('organization_id') || params.get('org_id')
      };
    }

    async function init() {
      try {
        showDebug('Starting initialization...');

        if (typeof window.AppExtensionsSDK !== 'function') {
          showError('Pipedrive SDK global not available');
          return;
        }

        showDebug('Instantiating SDK...');
        sdk = new window.AppExtensionsSDK();
        await sdk.initialize();
        showDebug('SDK initialized successfully');

        let context;

        if (typeof sdk.getContext === 'function') {
          try {
            context = await sdk.getContext();
            showDebug('Context retrieved via sdk.getContext');
          } catch (contextError) {
            showDebug('sdk.getContext failed: ' + contextError.message);
          }
        }

        if (!context && sdk.context) {
          context = sdk.context;
          showDebug('Context read from sdk.context');
        }

        if (!context) {
          context = extractContextFromUrl();
          showDebug('Context derived from URL params');
        }

        showDebug('Context: ' + JSON.stringify(context));

        dealId = context && (context.dealId || context.deal_id) ? (context.dealId || context.deal_id) : null;
        selectedUserId = context && (context.userId || context.user_id) ? (context.userId || context.user_id) : null;

        showDebug('Deal ID: ' + dealId + ', User ID: ' + selectedUserId);

        if (!dealId) {
          showError('No deal ID available from SDK or URL');
          return;
        }

        await loadCommissionData();
      } catch (error) {
        console.error('Initialization error:', error);
        showDebug('Error: ' + error.message);
        showDebug('Stack: ' + error.stack);
        showError('Failed to initialize: ' + error.message);
      }
    }

    async function loadCommissionData() {
      try {
        showDebug('Fetching commission data...');

        const response = await fetch('/api/calculate-commission', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            dealId,
            selectedUserId
          })
        });

        showDebug('Response status: ' + response.status);

        if (!response.ok) {
          const errorText = await response.text();
          showDebug('Error response: ' + errorText);
          throw new Error('Failed to load commission data: ' + response.status);
        }

        const data = await response.json();
        showDebug('Data received: ' + JSON.stringify(data));

        commissionConfig = Array.isArray(data.commissionConfig) ? data.commissionConfig : [];
        displaySummary(data);
        renderCommissionRows();
        displayResults(Array.isArray(data.calculations) ? data.calculations : []);

        document.getElementById('loading').style.display = 'none';
        document.getElementById('content').style.display = 'block';
      } catch (error) {
        console.error('Error loading data:', error);
        showDebug('Load error: ' + error.message);
        showError('Failed to load commission data: ' + error.message);
      }
    }

    function displaySummary(data) {
      document.getElementById('dealValue').textContent = formatCurrency(data.dealValue || 0);
      document.getElementById('depositPercent').textContent = Number(data.depositPercent || 0).toFixed(0);
      document.getElementById('depositAmount').textContent = formatCurrency(data.depositAmount || 0);
      document.getElementById('remainingAmount').textContent = formatCurrency(data.remainingAmount || 0);
    }

    function renderCommissionRows() {
      const container = document.getElementById('commissionRows');
      container.innerHTML = '';

      if (commissionConfig.length === 0) {
        commissionConfig = [
          { name: 'Mathieu', percent: 65, fixed: 0, appliesTo: 'total' },
          { name: 'Sacha', percent: 35, fixed: 0, appliesTo: 'total' }
        ];
      }

      commissionConfig.forEach((config, index) => {
        const row = document.createElement('div');
        row.className = 'row';
        row.innerHTML = `
          <input
            type="text"
            placeholder="Name"
            value="${config.name || ''}"
            onchange="updateConfig(${index}, 'name', this.value)"
            style="flex: 2;"
          >
          <input
            type="number"
            placeholder="%"
            value="${Number(config.percent || 0)}"
            onchange="updateConfig(${index}, 'percent', parseFloat(this.value))"
            style="flex: 1;"
          >
          <span class="small">%</span>
          <input
            type="number"
            placeholder="Fixed"
            value="${Number(config.fixed || 0)}"
            onchange="updateConfig(${index}, 'fixed', parseFloat(this.value))"
            style="flex: 1;"
          >
          <span class="small">â‚¬</span>
          <select onchange="updateConfig(${index}, 'appliesTo', this.value)" style="flex: 1;">
            <option value="total" ${config.appliesTo === 'total' ? 'selected' : ''}>Total</option>
            <option value="deposit" ${config.appliesTo === 'deposit' ? 'selected' : ''}>Deposit</option>
          </select>
          <button class="btn-remove" onclick="removeRow(${index})">âœ•</button>
        `;
        container.appendChild(row);
      });
    }

    function updateConfig(index, field, value) {
      commissionConfig[index][field] = value;
    }

    function addRow() {
      commissionConfig.push({
        name: '',
        percent: 0,
        fixed: 0,
        appliesTo: 'total'
      });
      renderCommissionRows();
    }

    function removeRow(index) {
      commissionConfig.splice(index, 1);
      renderCommissionRows();
    }

    async function saveAndCalculate() {
      try {
        showDebug('Saving configuration...');

        if (sdk && typeof sdk.execute === 'function' && window.AppExtensionsSDK && window.AppExtensionsSDK.Command && window.AppExtensionsSDK.Command.UPDATE) {
          await sdk.execute(window.AppExtensionsSDK.Command.UPDATE, {
            commission_config_json: JSON.stringify(commissionConfig)
          });
          showDebug('Configuration saved via SDK command, reloading...');
        } else {
          showDebug('SDK update command unavailable. Skipping direct save; consider implementing server-side persistence.');
        }

        await loadCommissionData();
      } catch (error) {
        console.error('Error saving:', error);
        showDebug('Save error: ' + error.message);
        showError('Failed to save configuration: ' + error.message);
      }
    }

    function displayResults(calculations) {
      const tbody = document.getElementById('resultsBody');
      tbody.innerHTML = '';
      let totalSum = 0;

      calculations.forEach((calc) => {
        const appliesTo = calc.appliesTo || 'total';
        const row = document.createElement('tr');
        row.innerHTML = `
          <td><strong>${calc.name || ''}</strong></td>
          <td><span class="badge badge-${appliesTo}">${appliesTo}</span></td>
          <td class="text-right currency">${formatCurrency(calc.baseAmount || 0)}</td>
          <td class="text-right">${Number(calc.percent || 0)}%</td>
          <td class="text-right currency">${formatCurrency(calc.percentAmount || 0)}</td>
          <td class="text-right currency">${formatCurrency(calc.fixed || 0)}</td>
          <td class="text-right currency"><strong>${formatCurrency(calc.total || 0)}</strong></td>
        `;
        tbody.appendChild(row);
        totalSum += Number(calc.total || 0);
      });

      const totalRow = document.createElement('tr');
      totalRow.className = 'total-row';
      totalRow.innerHTML = `
        <td colspan="6" class="text-right"><strong>TOTAL</strong></td>
        <td class="text-right currency"><strong>${formatCurrency(totalSum)}</strong></td>
      `;
      tbody.appendChild(totalRow);
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>
